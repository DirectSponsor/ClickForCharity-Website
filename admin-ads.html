<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin – Surf Ads Management</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <button class="menu-toggle" aria-controls="site-navigation" aria-expanded="false">☰ Menu</button>
    <div class="menu-overlay" data-menu-overlay></div>
    <div class="container">
        <aside class="sidebar" id="site-navigation">
            <div class="logo">
                <img src="images/logo.svg" alt="Click for Charity" width="40" height="40">
                <span>Click for Charity</span>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="ptc.html">Surf Ads</a></li>
                    <li><a href="simple-tasks.html">Simple Tasks</a></li>
                    <li><a href="skipped-tasks.html">Skipped Tasks</a></li>
                    <li><a href="surveys.html">Surveys</a></li>
                    <li><a href="offers.html">Offers</a></li>
                    <li><a href="admin.html">Admin Dashboard</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content" data-menu-target>
            <section class="admin-form" aria-labelledby="admin-form-heading">
                <h1 id="admin-form-heading">Surf Ad Management</h1>
                <p class="section-nav">
                    <a href="#create-task">Create Task</a> | 
                    <a href="#manage-tasks">Manage Tasks</a> | 
                    <a href="admin.html">← Admin Dashboard</a> | 
                    <a href="ptc.html" target="_blank">View Live Page</a>
                </p>
                
                <h2 id="create-task">Create a Surf Ad Task</h2>
                <p class="description">Fill in the fields and submit. The task will be saved automatically to <code>data/ads/</code>. Keep instructions concise so members know exactly what to do.</p>
                <form id="task-form">
                    <div class="field">
                        <label for="task-title">Title</label>
                        <input type="text" id="task-title" name="title" maxlength="120" required placeholder="e.g. Explore Example.com homepage">
                    </div>
                    <div class="field">
                        <label for="task-duration">Timer (seconds)</label>
                        <input type="number" id="task-duration" name="duration" min="5" max="600" step="5" value="20" required>
                    </div>
                    <div class="field">
                        <label for="campaign-duration">Campaign Duration</label>
                        <select id="campaign-duration" name="campaignDuration" required>
                            <option value="1">1 day</option>
                            <option value="2">2 days</option>
                            <option value="7">1 week</option>
                            <option value="30">1 month</option>
                            <option value="0" selected>Indefinite</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="task-reward">Reward (tokens/coins)</label>
                        <input type="number" id="task-reward" name="reward" min="1" max="1000" step="1" value="10" required>
                    </div>
                    <div class="field">
                        <label for="task-url">Destination URL</label>
                        <input type="url" id="task-url" name="url" placeholder="https://" required>
                    </div>
                    <div class="field">
                        <label for="task-instructions">Instructions</label>
                        <textarea id="task-instructions" name="instructions" maxlength="500" required placeholder="Describe exactly what the member must do before returning."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn primary">Save Task</button>
                        <button type="button" id="new-task-btn" class="btn secondary" style="display:none;">Create Another Task</button>
                        <span id="form-feedback" role="status"></span>
                    </div>
                </form>
                
                <h2 id="manage-tasks" style="margin-top: 60px;">Manage Existing Tasks</h2>
                <p class="description">View and delete existing surf ad tasks.</p>
                <div style="margin-bottom: 20px;">
                    <button id="reset-completed-btn" class="btn secondary">Reset Completed Tasks (for testing)</button>
                    <span id="reset-feedback" style="margin-left: 10px; color: #27ae60;"></span>
                </div>
                <div id="task-management-list" class="task-management-list">
                    <p class="loading-state">Loading tasks...</p>
                </div>
            </section>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
    <script>
        // Check admin privileges on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await requireAdmin();
        });
        
        // Form handling
        (function() {
        // Global variables
        const form = document.getElementById('task-form');
        const feedbackEl = document.getElementById('form-feedback');
        const submitButton = form.querySelector('button[type="submit"]');
        const newTaskBtn = document.getElementById('new-task-btn');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(form);
            const title = formData.get('title').trim();
            const duration = Number(formData.get('duration'));
            const reward = Number(formData.get('reward'));
            const url = formData.get('url').trim();
            const instructions = formData.get('instructions').trim();
            const campaignDuration = Number(formData.get('campaignDuration'));

            if (!title || !url || !instructions || !duration || !reward) {
                feedbackEl.textContent = 'Please fill all fields.';
                feedbackEl.style.color = '#c0392b';
                return;
            }

            const task = { title, instructions, url, reward, duration, campaignDuration };

            submitButton.disabled = true;
            feedbackEl.textContent = 'Saving...';
            feedbackEl.style.color = '#777';

            try {
                const response = await fetch('/api/save-ad.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(task)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    submitButton.textContent = 'Saved ✓';
                    submitButton.style.backgroundColor = '#368038';
                    submitButton.style.display = 'none';
                    newTaskBtn.style.display = 'inline-block';
                    feedbackEl.textContent = '';
                    
                    // Disable all form inputs
                    Array.from(form.elements).forEach(el => {
                        if (el.type !== 'button') el.disabled = true;
                    });
                    
                    loadTasks(); // Refresh task list
                } else {
                    feedbackEl.textContent = result.error || 'Failed to save task.';
                    feedbackEl.style.color = '#c0392b';
                    submitButton.disabled = false;
                }
            } catch (error) {
                console.error('Save error:', error);
                feedbackEl.textContent = 'Network error. Please try again.';
                feedbackEl.style.color = '#c0392b';
                submitButton.disabled = false;
            }
        });

        newTaskBtn.addEventListener('click', () => {
            form.reset();
            Array.from(form.elements).forEach(el => el.disabled = false);
            submitButton.textContent = 'Save Task';
            submitButton.style.backgroundColor = '';
            submitButton.style.display = 'inline-block';
            submitButton.disabled = false;
            newTaskBtn.style.display = 'none';
            feedbackEl.textContent = '';
        });
        })();

        // Task management
        (function() {
            const taskListEl = document.getElementById('task-management-list');

            async function loadTasks() {
                try {
                    const response = await fetch('/api/get-ads.php');
                    const tasks = await response.json();

                    if (!tasks || tasks.length === 0) {
                        taskListEl.innerHTML = '<p class="empty-state">No tasks found. Create one above!</p>';
                        return;
                    }

                    taskListEl.innerHTML = tasks.map(task => `
                        <div class="admin-task-item" data-task-id="${task.id}">
                            <div class="admin-task-info">
                                <h3>${task.title}</h3>
                                <p class="admin-task-meta">
                                    <strong>ID:</strong> ${task.id} | 
                                    <strong>Timer:</strong> ${task.duration}s | 
                                    <strong>Reward:</strong> ${task.reward} | 
                                    <strong>Duration:</strong> ${task.campaignDuration === 0 ? 'Indefinite' : task.campaignDuration + ' days'}
                                </p>
                                <p class="admin-task-instructions">${task.instructions}</p>
                                <p class="admin-task-url"><a href="${task.url}" target="_blank" rel="noopener">${task.url}</a></p>
                            </div>
                            <div class="admin-task-actions">
                                <button class="btn-delete-admin" data-task-id="${task.id}">Delete</button>
                            </div>
                        </div>
                    `).join('');

                    // Add delete handlers
                    taskListEl.querySelectorAll('.btn-delete-admin').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const taskId = parseInt(btn.dataset.taskId, 10);
                            const taskItem = btn.closest('.admin-task-item');
                            const taskTitle = taskItem.querySelector('h3').textContent;

                            if (!confirm(`Delete "${taskTitle}"?`)) return;

                            try {
                                const response = await fetch('/api/delete-ad.php', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: taskId })
                                });

                                const result = await response.json();
                                if (response.ok && result.success) {
                                    taskItem.remove();
                                    if (taskListEl.children.length === 0) {
                                        taskListEl.innerHTML = '<p class="empty-state">No tasks found. Create one above!</p>';
                                    }
                                    
                                    // Show success message
                                    const message = result.message || 'Ad marked for deletion';
                                    alert(message);
                                } else {
                                    alert(result.error || 'Failed to delete task');
                                }
                            } catch (error) {
                                console.error('Delete error:', error);
                                alert('Network error. Please try again.');
                            }
                        });
                    });
                } catch (error) {
                    console.error('Failed to load tasks:', error);
                    taskListEl.innerHTML = '<p class="error-state">Error loading tasks. Please refresh the page.</p>';
                }
            }

            // Load tasks on page load
            loadTasks();
        })();

        // Reset completed tasks
        (function() {
            const resetBtn = document.getElementById('reset-completed-btn');
            const feedbackEl = document.getElementById('reset-feedback');

            resetBtn.addEventListener('click', () => {
                if (!confirm('Clear all completed tasks from localStorage? This will let you test tasks again.')) return;

                try {
                    localStorage.removeItem('completed_tasks');
                    feedbackEl.textContent = '✓ Completed tasks reset!';
                    setTimeout(() => {
                        feedbackEl.textContent = '';
                    }, 3000);
                } catch (error) {
                    console.error('Reset error:', error);
                    feedbackEl.textContent = 'Error resetting tasks';
                    feedbackEl.style.color = '#c0392b';
                }
            });
        })();
    </script>
</body>
</html>
