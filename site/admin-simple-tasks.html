<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="canonical" href="https://clickforcharity.net/admin-simple-tasks.html">
    <!-- Open Graph Meta Tags -->
    <meta property="og:url" content="https://clickforcharity.net/admin-simple-tasks.html">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Click for Charity – No Money Needed, just your clicks!">
    <meta property="og:description"
        content="Do simple tasks to help people change their lives and live in abundance. No middlemen; 100% of site revenue goes to the recipients.">
    <meta property="og:image" content="https://clickforcharity.net/images/cover1400x500.jpeg">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="clickforcharity.net">
    <meta property="twitter:url" content="https://clickforcharity.net/admin-simple-tasks.html">
    <meta name="twitter:title" content="Click for Charity – No Money Needed, just your clicks!">
    <meta name="twitter:description"
        content="Do simple tasks to help real people change their lives and live in abundance. No middlemen; 100% of site revenue goes to the recipients.">
    <meta name="twitter:image" content="https://clickforcharity.net/images/cover1400x500.jpeg">

    <title>Admin – Tasks Management</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <header style="margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; padding-bottom: 20px;">
            <a href="index.html" class="logo"
                style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit;">
                <img src="images/logo.svg" alt="Click for Charity" width="40" height="40">
                <span>Click for Charity</span>
            </a>
        </header>
        <main>
            <section class="admin-form" aria-labelledby="admin-form-heading">
                <h1 id="admin-form-heading">Tasks Management</h1>
                <p class="section-nav">
                    <a href="#create-task">Create Task</a> |
                    <a href="#manage-tasks">Manage Tasks</a> |
                    <a href="admin.html">← Admin Dashboard</a> |
                    <a href="simple-tasks.html" target="_blank">View Live Page</a>
                </p>

                <h2 id="create-task">Create a Task</h2>
                <p class="description">Create tasks for users to complete. Choose the category and platform, set rewards
                    and timers.</p>
                <form id="task-form">
                    <div class="field">
                        <label for="task-title">Title</label>
                        <input type="text" id="task-title" name="title" maxlength="120" required
                            placeholder="e.g. Follow DirectSponsor on X">
                    </div>
                    <div class="field">
                        <label for="task-short-description">Short Description</label>
                        <input type="text" id="task-short-description" name="shortDescription" maxlength="200" required
                            placeholder="Brief description shown in compact view">
                    </div>
                    <div class="field">
                        <label for="task-instructions">Instructions</label>
                        <textarea id="task-instructions" name="instructions" maxlength="500" required
                            placeholder="Detailed step-by-step instructions for the user">1. Click the Visit button to open the target page
2. Follow the specific instructions for that platform
3. Return here and click Complete when done</textarea>
                    </div>
                    <div class="field">
                        <label for="task-url">Destination URL</label>
                        <input type="url" id="task-url" name="url" placeholder="https://" required>
                    </div>
                    <div class="field">
                        <label for="task-duration">Timer (seconds)</label>
                        <input type="number" id="task-duration" name="duration" min="5" max="59" step="5" value="20"
                            required>
                        <small>Maximum 59 seconds to avoid browser throttling</small>
                    </div>
                    <div class="field">
                        <label for="task-reward">Reward (tokens/coins)</label>
                        <input type="number" id="task-reward" name="reward" min="1" max="1000" step="1" value="25"
                            required>
                    </div>
                    <div class="field">
                        <label for="task-category">Category</label>
                        <select id="task-category" name="category" required>
                            <option value="engagements">Engagements (Likes, Comments, etc.)</option>
                            <option value="follows">Follows & Subscriptions</option>
                            <option value="other">Other (SEO, Surveys, Misc.)</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="task-platform">Platform</label>
                        <select id="task-platform" name="platform" required>
                            <option value="none">None (shows to everyone)</option>
                            <option value="x">X (Twitter)</option>
                            <option value="youtube">YouTube</option>
                            <option value="facebook">Facebook</option>
                            <option value="instagram">Instagram</option>
                            <option value="tiktok">TikTok</option>
                            <option value="odysee">Odysee</option>
                            <option value="publish0x">Publish0x</option>
                            <option value="minds">Minds</option>
                        </select>
                        <small>Select "None" for tasks that show to all users regardless of platform membership</small>
                    </div>
                    <div class="field">
                        <label>
                            <input type="checkbox" id="task-enabled" name="enabled" value="true" checked>
                            Enabled (task is active and visible to users)
                        </label>
                    </div>
                    <div class="field">
                        <label for="task-expiry">Expiry Date (optional)</label>
                        <input type="date" id="task-expiry" name="expiryDate">
                        <small>Leave blank for no expiry. Task will be hidden after this date.</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn primary">Save Task</button>
                        <button type="button" id="new-task-btn" class="btn secondary" style="display:none;">Create
                            Another Task</button>
                        <span id="form-feedback" role="status"></span>
                    </div>
                </form>

                <h2 id="manage-tasks" style="margin-top: 60px;">Manage Existing Tasks</h2>
                <p class="description">View and delete existing simple tasks. Currently using mock data - backend
                    integration coming soon.</p>
                <div style="margin-bottom: 20px;">
                    <button id="reset-completed-btn" class="btn secondary">Reset Completed Tasks (for testing)</button>
                    <button id="reset-skipped-btn" class="btn secondary">Reset Skipped Tasks (for testing)</button>
                    <span id="reset-feedback" style="margin-left: 10px; color: #27ae60;"></span>
                </div>
                <div id="task-management-list" class="task-management-list">
                    <p class="loading-state">Loading tasks...</p>
                </div>
            </section>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
    <script>
        // Check admin privileges on page load
        (async () => {
            const isAdmin = await window.requireAdmin();
            if (!isAdmin) return;
        })();

        // Global variables
        let loadTasks;

        // Form handling
        (function () {
            const form = document.getElementById('task-form');
            const feedbackEl = document.getElementById('form-feedback');
            const submitButton = form.querySelector('button[type="submit"]');
            const newTaskBtn = document.getElementById('new-task-btn');

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const formData = new FormData(form);
                const title = formData.get('title').trim();
                const shortDescription = formData.get('shortDescription').trim();
                const instructions = formData.get('instructions').trim();
                const url = formData.get('url').trim();
                const duration = Number(formData.get('duration'));
                const reward = Number(formData.get('reward'));
                const category = formData.get('category');
                const platform = formData.get('platform');
                const repeatable = false; // All tasks are one-time by default
                const enabled = document.getElementById('task-enabled').checked;
                const expiryDate = formData.get('expiryDate') || null;

                if (!title || !shortDescription || !instructions || !url || !duration || !reward || !category || !platform) {
                    feedbackEl.textContent = 'Please fill all fields.';
                    feedbackEl.style.color = '#c0392b';
                    return;
                }

                const task = {
                    title,
                    shortDescription,
                    instructions,
                    url,
                    reward,
                    duration,
                    category,
                    platform,
                    repeatable,
                    enabled,
                    expiryDate
                };

                submitButton.disabled = true;
                feedbackEl.textContent = 'Saving...';
                feedbackEl.style.color = '#777';

                try {
                    const response = await fetch('/api/save-complex-task.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(task)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        submitButton.textContent = 'Saved ✓';
                        submitButton.style.backgroundColor = '#368038';
                        submitButton.style.display = 'none';
                        newTaskBtn.style.display = 'inline-block';
                        feedbackEl.textContent = '';

                        // Disable all form inputs
                        Array.from(form.elements).forEach(el => {
                            if (el.type !== 'button') el.disabled = true;
                        });

                        loadTasks(); // Refresh task list
                    } else {
                        feedbackEl.textContent = result.error || 'Failed to save task.';
                        feedbackEl.style.color = '#c0392b';
                        submitButton.disabled = false;
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    feedbackEl.textContent = 'Network error. Please try again.';
                    feedbackEl.style.color = '#c0392b';
                    submitButton.disabled = false;
                }
            });

            newTaskBtn.addEventListener('click', () => {
                form.reset();
                Array.from(form.elements).forEach(el => el.disabled = false);
                submitButton.textContent = 'Save Task';
                submitButton.style.backgroundColor = '';
                submitButton.style.display = 'inline-block';
                submitButton.disabled = false;
                newTaskBtn.style.display = 'none';
                feedbackEl.textContent = '';
            });
        })();

        // Task management
        (function () {
            const taskListEl = document.getElementById('task-management-list');

            loadTasks = async function () {
                try {
                    const response = await fetch('/api/get-complex-tasks.php?all=true');
                    const data = await response.json();
                    const tasks = data.tasks || [];

                    if (!tasks || tasks.length === 0) {
                        taskListEl.innerHTML = '<p class="empty-state">No tasks found. Create one above!</p>';
                        return;
                    }

                    taskListEl.innerHTML = tasks.map(task => `
                        <div class="admin-task-item" data-task-id="${task.id}">
                            <div class="admin-task-info">
                                <h3>${task.title} ${task.enabled ? '' : '<span style="color:#c0392b;">(Disabled)</span>'}</h3>
                                <p class="admin-task-meta">
                                    <strong>ID:</strong> ${task.id} | 
                                    <strong>Category:</strong> ${task.category} | 
                                    <strong>Platform:</strong> ${task.platform} | 
                                    <strong>Timer:</strong> ${task.duration}s | 
                                    <strong>Reward:</strong> ${task.reward} | 
                                    <strong>Repeatable:</strong> ${task.repeatable ? 'Yes' : 'No'}
                                </p>
                                <p class="admin-task-short-desc">${task.shortDescription}</p>
                                <p class="admin-task-instructions">${task.instructions}</p>
                                <p class="admin-task-url"><a href="${task.url}" target="_blank" rel="noopener">${task.url}</a></p>
                            </div>
                            <div class="admin-task-actions">
                                <button class="btn-delete-admin" data-task-id="${task.id}">Delete</button>
                            </div>
                        </div>
                    `).join('');

                    // Add delete handlers
                    taskListEl.querySelectorAll('.btn-delete-admin').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const taskId = btn.dataset.taskId;
                            const taskItem = btn.closest('.admin-task-item');
                            const taskTitle = taskItem.querySelector('h3').textContent;

                            if (!confirm(`Delete "${taskTitle}"?`)) return;

                            try {
                                const response = await fetch('/api/delete-complex-task.php', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: taskId })
                                });

                                const result = await response.json();
                                if (response.ok && result.success) {
                                    taskItem.remove();
                                    if (taskListEl.children.length === 0) {
                                        taskListEl.innerHTML = '<p class="empty-state">No tasks found. Create one above!</p>';
                                    }

                                    // Show success message
                                    const message = result.message || 'Task marked for deletion';
                                    alert(message);
                                } else {
                                    alert(result.error || 'Failed to delete task');
                                }
                            } catch (error) {
                                console.error('Delete error:', error);
                                alert('Network error. Please try again.');
                            }
                        });
                    });
                } catch (error) {
                    console.error('Failed to load tasks:', error);
                    taskListEl.innerHTML = '<p class="error-state">Error loading tasks. Please refresh the page.</p>';
                }
            };

            // Load tasks on page load
            loadTasks();
        })();

        // Reset completed tasks
        (function () {
            const resetBtn = document.getElementById('reset-completed-btn');
            const resetSkippedBtn = document.getElementById('reset-skipped-btn');
            const feedbackEl = document.getElementById('reset-feedback');

            resetBtn.addEventListener('click', () => {
                if (!confirm('Clear all completed tasks from localStorage? This will let you test tasks again.')) return;

                try {
                    localStorage.removeItem('completed_tasks');
                    feedbackEl.textContent = '✓ Completed tasks reset!';
                    setTimeout(() => {
                        feedbackEl.textContent = '';
                    }, 3000);
                } catch (error) {
                    console.error('Reset error:', error);
                    feedbackEl.textContent = 'Error resetting tasks';
                    feedbackEl.style.color = '#c0392b';
                }
            });

            resetSkippedBtn.addEventListener('click', () => {
                if (!confirm('Clear all skipped tasks from localStorage? This will let you test tasks again.')) return;

                try {
                    localStorage.removeItem('skipped_tasks');
                    feedbackEl.textContent = '✓ Skipped tasks reset!';
                    setTimeout(() => {
                        feedbackEl.textContent = '';
                    }, 3000);
                } catch (error) {
                    console.error('Reset error:', error);
                    feedbackEl.textContent = 'Error resetting tasks';
                    feedbackEl.style.color = '#c0392b';
                }
            });
        })();
    </script>
</body>

</html>